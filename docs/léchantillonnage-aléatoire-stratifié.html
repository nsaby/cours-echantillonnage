<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 L’échantillonnage aléatoire stratifié | Cours sur les plans d’échantillonnage statistique dans l’espace pour l’étude des sols</title>
<meta name="author" content="Nicolas Saby, INRAe Infosol, Orléans France">
<meta name="description" content="Pour ce type d’approche, la population ou la zone d’étude est subdivisée en sous-populations, appelées strates. Les strates ne peuvent pas se chevaucher, et leur union doit correspondre à la...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 5 L’échantillonnage aléatoire stratifié | Cours sur les plans d’échantillonnage statistique dans l’espace pour l’étude des sols">
<meta property="og:type" content="book">
<meta property="og:description" content="Pour ce type d’approche, la population ou la zone d’étude est subdivisée en sous-populations, appelées strates. Les strates ne peuvent pas se chevaucher, et leur union doit correspondre à la...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 L’échantillonnage aléatoire stratifié | Cours sur les plans d’échantillonnage statistique dans l’espace pour l’étude des sols">
<meta name="twitter:description" content="Pour ce type d’approche, la population ou la zone d’étude est subdivisée en sous-populations, appelées strates. Les strates ne peuvent pas se chevaucher, et leur union doit correspondre à la...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.18/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Cours sur les plans d’échantillonnage statistique dans l’espace pour l’étude des sols</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Avant propos</a></li>
<li><a class="" href="WHY.html"><span class="header-section-number">2</span> Introduction</a></li>
<li><a class="" href="data.html"><span class="header-section-number">3</span> Données</a></li>
<li><a class="" href="SI.html"><span class="header-section-number">4</span> Echantillonnage aléatoire simple</a></li>
<li><a class="active" href="l%C3%A9chantillonnage-al%C3%A9atoire-stratifi%C3%A9.html"><span class="header-section-number">5</span> L’échantillonnage aléatoire stratifié</a></li>
<li><a class="" href="SY-QUICK.html"><span class="header-section-number">6</span> Echantillonnage aléatoire systématique</a></li>
<li><a class="" href="CARTO.html"><span class="header-section-number">7</span> Echantillonnage pour la cartographie</a></li>
<li><a class="" href="Script.html"><span class="header-section-number">8</span> Script final</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="léchantillonnage-aléatoire-stratifié" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> L’échantillonnage aléatoire stratifié<a class="anchor" aria-label="anchor" href="#l%C3%A9chantillonnage-al%C3%A9atoire-stratifi%C3%A9"><i class="fas fa-link"></i></a>
</h1>
<p>Pour ce type d’approche, la population ou la zone d’étude est subdivisée en sous-populations, appelées strates.</p>
<ul>
<li>Les strates ne peuvent pas se chevaucher, et leur union doit correspondre à la population étudiée.</li>
<li>Dans chaque strate, un échantillon est sélectionné au <strong>hasard</strong>
</li>
<li>Les strates peuvent être échantillonnées de nombreuses manières, par exemple par échantillonnage aléatoire (SI). Cela conduit à un échantillonnage aléatoire simple stratifié (STSI)</li>
<li>La méthode de sélection des unité par SI est appliquée à chaque strate séparément</li>
</ul>
<div id="pourquoi-stratifier" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Pourquoi stratifier ?<a class="anchor" aria-label="anchor" href="#pourquoi-stratifier"><i class="fas fa-link"></i></a>
</h2>
<p>Deux raisons possibles :</p>
<ul>
<li>Les estimations des paramètres statistiques pour la zone sont plus précises</li>
<li>Nous voulons des estimations séparées des paramètres statistiques pour les sous-populations</li>
</ul>
</div>
<div id="comment-stratifier" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Comment stratifier ?<a class="anchor" aria-label="anchor" href="#comment-stratifier"><i class="fas fa-link"></i></a>
</h2>
<p>Deux approches :</p>
<ul>
<li><p>Stratification à l’aide d’un variables auxiliaires</p></li>
<li><p>Variable catégorielle (unités cartographiques)</p></li>
<li><p>variable quantitative (par exemple, images de télédétection, altitude, variables dérivées…)</p></li>
<li><p>Stratification par la position géographique uniquement (X et Y)</p></li>
</ul>
</div>
<div id="estimateurs-stsi" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Estimateurs STSI<a class="anchor" aria-label="anchor" href="#estimateurs-stsi"><i class="fas fa-link"></i></a>
</h2>
<p>L’estimateur de la moyenne STSI est le suivant</p>
<p><span class="math inline">\(\hat{ \overline{z} } = \sum_{h=1}^{H} w_h \hat{\overline{z} }_{h}\)</span></p>
<p>avec <span class="math inline">\(w_h = A_h/\sum_{h}A_h\)</span> et <span class="math inline">\(\hat{\overline{z} }_{h}\)</span> est l’estimateur SI de chaque strate <span class="math inline">\(h\)</span> avec un échantillonnage aléatoire simple.</p>
<p>La variance d’échantillonnage de la moyenne expérimentale des <span class="math inline">\(z\)</span> est :</p>
<p><span class="math display">\[\begin{equation}

V(\hat{ \overline{z} } )  = \sum_{h=1}^{H} w_h^2 \frac{ \hat{ S^2_h} (\hat{ \overline{z} } ) }{n_h}
\end{equation}\]</span></p>
<p>où <span class="math inline">\(\hat{ S^2_h} (\hat{ \overline{z} })\)</span> est la variance SI dans la strate <span class="math inline">\(h\)</span> :</p>
<p><span class="math display">\[\begin{equation}
\hat{ S^2_h} (\hat{ \overline{z} })= \frac{1}{n_h-1}\sum_{i=1}^{n_h} ( z_{hi}  -\hat{\overline{z}}_h )
\end{equation}\]</span></p>
</div>
<div id="stratification-géographique-par-strates-compactes-géographiques" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> Stratification géographique par strates compactes géographiques<a class="anchor" aria-label="anchor" href="#stratification-g%C3%A9ographique-par-strates-compactes-g%C3%A9ographiques"><i class="fas fa-link"></i></a>
</h2>
<p>Parfois, il n’existe pas d’information a priori sur la variabilité spatiale de la propriété visée. Dans ce cas, une bonne répartition spatiale peut</p>
<div id="définition-2" class="section level3" number="5.4.1">
<h3>
<span class="header-section-number">5.4.1</span> Définition<a class="anchor" aria-label="anchor" href="#d%C3%A9finition-2"><i class="fas fa-link"></i></a>
</h3>
<p>Dans cette approche, les <span class="math inline">\(n\)</span> observations sont réparties de manière optimale au sein de la zone d’étude. Pour cela, on utilise un critère qui minimise la distance entre les observations et un discrétisation de la zone d’étude.
La moyenne du carré de la plus courte distance au point j:</p>
<p><span class="math inline">\(MCPCD_j = 1/N \sum^N_{i=1}min_j(D_{ij}^2)\)</span></p>
<p>Le critère <span class="math inline">\(MCPCD_j\)</span> peut être minimisé en utilisant l’algorithme des K-moyenne</p>
<p>Il existe un package R <code>spcosa</code> de <span class="citation"><a href="references.html#ref-walvoort_r_2010" role="doc-biblioref">Walvoort, Brus, and Gruijter</a> (<a href="references.html#ref-walvoort_r_2010" role="doc-biblioref">2010</a>)</span>.</p>
<p>Dans cette appraoche, il n’est pas nécessaire de définir un variogramme a priori pour l’optimisation de la répartition des <span class="math inline">\(n\)</span> observations. Les strates ainsi définies sont appelées <strong>Strates compactes</strong></p>
</div>
<div id="estimateurs-stsi-1" class="section level3" number="5.4.2">
<h3>
<span class="header-section-number">5.4.2</span> Estimateurs STSI<a class="anchor" aria-label="anchor" href="#estimateurs-stsi-1"><i class="fas fa-link"></i></a>
</h3>
<p>Ici, comme les strates ont la même surface et donc le même poids, on peut simplifier les estimateurs</p>
<p>En effet, on peut simplifier les poids : <span class="math inline">\(w_h = A_h/\sum_{h}A_h = 1/H\)</span></p>
<p>La moyenne:</p>
<p><br><span class="math display">\[\begin{equation}

\hat{ \overline{z} } = \sum_{h=1}^{H} \frac1H \hat{\overline{z} }_{h}
\end{equation}\]</span></p>
<p>et</p>
<p><span class="math display">\[\begin{equation}
\hat{\overline{z}}_{h} =\frac1{n_h} \sum_{i=1}^{n_h}z_i
\end{equation}\]</span></p>
<p>Si en plus le nombre d’observations est le même par strate (<span class="math inline">\(n_h\)</span>), on obtient une formule assez simple</p>
<p><span class="math display">\[\begin{equation}

\hat{ \overline{z} } =  \frac1N \sum_{i=1}^{N} z_i
\end{equation}\]</span></p>
<p>Pour la variance d’échantillonnage, il en va de même.</p>
<p><span class="math display">\[\begin{equation}
V(\hat{ \overline{z^l} } )  = (\frac1H)^2 \sum_{h=1}^{H}  \frac{ \hat{ S^2_h} (\hat{ \overline{z^l} } ) }{n_h}
\end{equation}\]</span></p>
</div>
<div id="implémentation" class="section level3" number="5.4.3">
<h3>
<span class="header-section-number">5.4.3</span> Implémentation<a class="anchor" aria-label="anchor" href="#impl%C3%A9mentation"><i class="fas fa-link"></i></a>
</h3>
<p>Il est conseillé de tirer au hasard 2 points par strate afin de pouvoir calculer une variance. Il suffit ensuite d’adapter le nombre de strate pour atteindre le nombre d’unités d’échantillonnage visé.</p>
<p>Avec cette méthode, il est possible de répartir au mieux les unités dans l’espace.</p>
<p>Ici, on avait retenu 20 unités, soit donc 10 strates.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>

<span class="va">champSP.r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">champSP</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/resolution.html">res</a></span><span class="op">(</span><span class="va">champSP.r</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 1 1</code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#aggregate from 1x1 resolution to 2x2 (factor = 2)</span>
<span class="va">champSP.r.aggregate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">champSP.r</span>, 
                                 fact <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/resolution.html">res</a></span><span class="op">(</span><span class="va">champSP.r.aggregate</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 2 2</code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">champSP.r.aggregate</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">champSP.r.aggregate</span> , <span class="st">"SpatialPixels"</span><span class="op">)</span>

<span class="co"># compute compact geographical strata</span>
<span class="va">myStrata</span> <span class="op">&lt;-</span> <span class="fu">stratify</span><span class="op">(</span><span class="va">champSP.r.aggregate</span>,
                     nStrata <span class="op">=</span> <span class="fl">10</span>,
                     equalArea<span class="op">=</span><span class="cn">TRUE</span>, 
                     nTry<span class="op">=</span><span class="fl">5</span>
                     <span class="op">)</span>
<span class="fu">spcosa</span><span class="fu">::</span><span class="fu">plot</span><span class="op">(</span><span class="va">myStrata</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="cours-echantillonnage_files/figure-html/unnamed-chunk-17-1.png" width="100%"></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># obtain the surface areas of the strata</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">areaStrata</span><span class="op">&lt;-</span><span class="fu">getArea</span><span class="op">(</span><span class="va">myStrata</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    0    1    2    3    4    5    6    7    8    9 
## 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000</code></pre>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># select randomly n locations from the strata</span>
<span class="va">mySample</span> <span class="op">&lt;-</span> <span class="fu">spsample</span><span class="op">(</span><span class="va">myStrata</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">myStrata</span>, <span class="va">mySample</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="cours-echantillonnage_files/figure-html/unnamed-chunk-17-2.png" width="100%"></div>
<p>Comparons les deux approches: SI et STSI avec strates compactes</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">STSI</span> <span class="op">&lt;-</span> <span class="fu">tm_shape</span><span class="op">(</span><span class="va">champSP</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_raster</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">tm_shape</span><span class="op">(</span><span class="va">mySample</span><span class="op">@</span><span class="va">sample</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">tm_symbols</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
<span class="fu">tm_layout</span><span class="op">(</span>legend.outside <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu">tmap_arrange</span><span class="op">(</span><span class="va">SI</span>, <span class="va">STSI</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="cours-echantillonnage_files/figure-html/unnamed-chunk-18-1.png" width="100%"></div>
<p>Examinons ce que donne la simulation pour le calcul de la moyenne. On interroge ainsi au droit des pixels les points d’échantillonnage. c’est une opération SIG classique. Puis, on calule la moyenne en utilisant l’estimateur classique.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">terrainSTSI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">over</a></span><span class="op">(</span><span class="va">mySample</span><span class="op">@</span><span class="va">sample</span>,<span class="va">champSP</span><span class="op">)</span>

<span class="va">MoyEstSTSI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">terrainSTSI</span><span class="op">$</span><span class="va">sim1</span><span class="op">)</span>

<span class="va">MoyEstSTSI</span></code></pre></div>
<pre><code>## [1] 5.055314</code></pre>
<p>Et pour la variance, il est nécessaire de calculer la variance par state et de calculer ensuite la moyenne de ces variances.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">StratesSTSI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">over</a></span><span class="op">(</span><span class="va">mySample</span><span class="op">@</span><span class="va">sample</span>,<span class="va">myStrata</span><span class="op">@</span><span class="va">cells</span><span class="op">)</span>

<span class="va">myStrata</span><span class="op">@</span><span class="va">stratumId</span><span class="op">[</span><span class="va">StratesSTSI</span><span class="op">]</span></code></pre></div>
<pre><code>##  [1] 0 0 1 1 2 2 3 3 4 4 5 5 6 6 7 7 8 8 9 9</code></pre>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind.data.frame</a></span><span class="op">(</span>
  strate <span class="op">=</span> <span class="va">myStrata</span><span class="op">@</span><span class="va">stratumId</span><span class="op">[</span><span class="va">StratesSTSI</span><span class="op">]</span>,
  z<span class="op">=</span> <span class="va">terrainSTSI</span><span class="op">$</span><span class="va">sim1</span>
  
<span class="op">)</span>

<span class="va">Varh</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">Mydata</span><span class="op">$</span><span class="va">z</span>, INDEX<span class="op">=</span><span class="va">Mydata</span><span class="op">$</span><span class="va">strate</span>,FUN<span class="op">=</span><span class="va">var</span><span class="op">)</span>

<span class="va">VStsi</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">10</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Varh</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>Voici donc la variance SI <span class="math inline">\(0.0414588\)</span> et la variance dans ce cas <span class="math inline">\(0.0060433\)</span></p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># calcul de l'interval de confiance selon les deux lois</span>
<span class="va">ICT</span> <span class="op">&lt;-</span> <span class="va">talpha</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">VStsi</span><span class="op">)</span>

<span class="co"># comme n&lt; 30, on garde ICT</span>
<span class="co"># Est-ce que la vraie moyenne est dans l'IC student</span>
<span class="va">Moy</span> <span class="op">&lt;</span> <span class="va">MoyEstSTSI</span> <span class="op">+</span> <span class="va">ICT</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Moy</span> <span class="op">&gt;</span> <span class="va">MoyEstSTSI</span> <span class="op">-</span> <span class="va">ICT</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">resSC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">MoyEstSTSI</span>, 
      ICbas <span class="op">=</span> <span class="va">MoyEstSTSI</span> <span class="op">-</span> <span class="va">ICT</span>,
      ICHaut <span class="op">=</span> <span class="va">MoyEstSTSI</span> <span class="op">+</span> <span class="va">ICT</span>, <span class="va">Moy</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##      MoyEstSTSI    ICbas   ICHaut      Moy
## [1,]   5.055314 4.892605 5.218023 5.298602</code></pre>
</div>
</div>
<div id="stratification-par-stratification-dune-donnée-quantitative" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> Stratification par stratification d’une donnée quantitative<a class="anchor" aria-label="anchor" href="#stratification-par-stratification-dune-donn%C3%A9e-quantitative"><i class="fas fa-link"></i></a>
</h2>
<div id="définition-3" class="section level3" number="5.5.1">
<h3>
<span class="header-section-number">5.5.1</span> Définition<a class="anchor" aria-label="anchor" href="#d%C3%A9finition-3"><i class="fas fa-link"></i></a>
</h3>
<p>Lorsqu’une covariable quanatitative est disponible en tous points de la zone d’étude, les strates peuvent être construite en utilisant la méthode appelée <em>cum-root-f</em> (voir <span class="citation"><a href="references.html#ref-Dalenius1959" role="doc-biblioref">Dalenius and Hodges</a> (<a href="references.html#ref-Dalenius1959" role="doc-biblioref">1959</a>)</span>).</p>
</div>
<div id="implementation" class="section level3" number="5.5.2">
<h3>
<span class="header-section-number">5.5.2</span> Implementation<a class="anchor" aria-label="anchor" href="#implementation"><i class="fas fa-link"></i></a>
</h3>
<p>Dans notre cas, nous allons simuler une covariables à partir de <code>champ</code></p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>

<span class="va">champSP.r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">champSP</span><span class="op">)</span>

<span class="va">cov</span> <span class="op">&lt;-</span> <span class="va">champSP.r</span><span class="op">^</span><span class="fl">2</span><span class="op">+</span><span class="va">champSP.r</span> <span class="op">+</span> <span class="fl">9</span><span class="op">*</span><span class="va">champSP.r</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">champSP.r</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span> n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">champSP.r</span><span class="op">@</span><span class="va">data</span><span class="op">@</span><span class="va">values</span><span class="op">)</span> , sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">cov</span><span class="op">[</span><span class="va">cov</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">cov</span>, main <span class="op">=</span> <span class="st">"la covariable"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="cours-echantillonnage_files/figure-html/unnamed-chunk-22-1.png" width="100%"></div>
<p>Les strates peuvent être construite avec le package <code>stratification</code>. Attention, les données doivent classer par ordre croissant avant la stratification.
En sortie, on dispose des limites des classes et de l’affectation de chaque observation à une strate.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">stratification</span><span class="op">)</span>
<span class="va">n.echantillons</span> <span class="op">&lt;-</span>  <span class="fl">20</span> 
<span class="va">n.strates</span> <span class="op">&lt;-</span>  <span class="fl">6</span> 
<span class="va">nclass</span> <span class="op">&lt;-</span> <span class="va">n.strates</span> <span class="op">*</span> <span class="fl">100</span> <span class="co">#nombre de classes pour calculer l'histogramme</span>

<span class="va">dt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/xyFromCell.html">coordinates</a></span><span class="op">(</span><span class="va">cov</span><span class="op">)</span>,cov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/getValues.html">values</a></span><span class="op">(</span><span class="va">cov</span><span class="op">)</span><span class="op">)</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dt</span><span class="op">$</span><span class="va">cov</span><span class="op">)</span>,<span class="op">]</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">dt</span><span class="op">$</span><span class="va">cov</span><span class="op">)</span>,<span class="op">]</span>


<span class="va">optstrata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/stratification/man/strata.rule.html">strata.cumrootf</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="va">dt</span><span class="op">$</span><span class="va">cov</span>,
  n <span class="op">=</span> <span class="va">n.echantillons</span>,
  Ls <span class="op">=</span> <span class="va">n.strates</span>,
  nclass <span class="op">=</span> <span class="va">nclass</span><span class="op">)</span>

<span class="va">optstrata</span><span class="op">$</span><span class="va">bh</span> <span class="co">#les limites des strates</span></code></pre></div>
<pre><code>## [1] 10.46404 17.84493 23.45067 28.86954 35.50300</code></pre>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">optstrata</span><span class="op">$</span><span class="va">Nh</span> <span class="co">#la taille des strates </span></code></pre></div>
<pre><code>## [1] 1254 1636 2098 2215 1849  948</code></pre>
<p>La figure suivante présente covariable dont la légende correspond à la limite des classes définies à l’étape précédente.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dessin de la stratification</span>

<span class="fu">tm_shape</span><span class="op">(</span><span class="va">cov</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_raster</span><span class="op">(</span>
    
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/getValues.html">values</a></span><span class="op">(</span><span class="va">cov</span><span class="op">)</span><span class="op">)</span>,<span class="va">optstrata</span><span class="op">$</span><span class="va">bh</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/getValues.html">values</a></span><span class="op">(</span><span class="va">cov</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                        <span class="op">)</span><span class="op">+</span>
  <span class="fu">tm_layout</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"la stratification"</span>,
            title.size <span class="op">=</span> <span class="fl">0.6</span>,
            legend.outside <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-24"></span>
<img src="cours-echantillonnage_files/figure-html/unnamed-chunk-24-1.png" alt="Carte des strates définies sur une variable quantitative" width="110%"><p class="caption">
Figure 5.1: Carte des strates définies sur une variable quantitative
</p>
</div>
<p>Ensuite, l’allocation des unités d’échantillonnage doit se faire au prorata des surfaces des strates. On nomme cela l’allocation de Newman. elle est idéal pour ce type de stratification</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w_h</span> <span class="op">&lt;-</span> <span class="va">optstrata</span><span class="op">$</span><span class="va">Nh</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">optstrata</span><span class="op">$</span><span class="va">Nh</span><span class="op">)</span>
<span class="op">(</span><span class="va">n_h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">w_h</span> <span class="op">*</span> <span class="va">n.echantillons</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 3 3 4 4 4 2</code></pre>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n_h</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 20</code></pre>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_h</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">n_h</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span>

<span class="co">#add optimal strata to data frame</span>
<span class="va">dt</span><span class="op">$</span><span class="va">strate</span> <span class="op">&lt;-</span> <span class="va">optstrata</span><span class="op">$</span><span class="va">stratumID</span>

<span class="co"># on ajoute l'observation</span>
<span class="va">dt</span><span class="op">$</span><span class="va">sim1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/getValues.html">values</a></span><span class="op">(</span><span class="va">champSP.r</span><span class="op">)</span></code></pre></div>
<p>On tire au hasard ensuite une échantillon alétoire simple stratifié selon la répartition définie.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#select stratified simple random sample</span>
<span class="va">units</span> <span class="op">&lt;-</span> <span class="fu">sampling</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sampling/man/strata.html">strata</a></span><span class="op">(</span>
  <span class="va">dt</span>, 
  stratanames <span class="op">=</span> <span class="st">"strate"</span>, 
  size <span class="op">=</span> <span class="va">n_h</span>,
  method <span class="op">=</span> <span class="st">"srswor"</span><span class="op">)</span></code></pre></div>
</div>
<div id="estimation" class="section level3" number="5.5.3">
<h3>
<span class="header-section-number">5.5.3</span> Estimation<a class="anchor" aria-label="anchor" href="#estimation"><i class="fas fa-link"></i></a>
</h3>
<p>Examinons ce que donne la simulation pour le calcul de la moyenne. cela consiste à interroger les pixels de la simulations comme dans la méthode précédente</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mysample</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">units</span><span class="op">$</span><span class="va">ID_unit</span>,<span class="op">]</span>


<span class="va">MoyEstSTSI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mysample</span><span class="op">$</span><span class="va">sim1</span><span class="op">)</span>

<span class="va">MoyEstSTSI</span></code></pre></div>
<pre><code>## [1] 5.149202</code></pre>
<p>Et pour la variance, il est nécessaire de calculer la variance par state et de calculer ensuite la moyenne de ces variances.</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mz_h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">mysample</span><span class="op">$</span><span class="va">sim1</span>, 
               INDEX <span class="op">=</span> <span class="va">mysample</span><span class="op">$</span><span class="va">strate</span>,
               FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>
<span class="op">(</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w_h</span> <span class="op">*</span> <span class="va">mz_h</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 5.18936</code></pre>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">S2z_h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">mysample</span><span class="op">$</span><span class="va">sim1</span>,
                INDEX <span class="op">=</span> <span class="va">mysample</span><span class="op">$</span><span class="va">strate</span>,
                FUN <span class="op">=</span> <span class="va">var</span><span class="op">)</span>

<span class="op">(</span><span class="va">v_mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w_h</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">n_h</span> <span class="op">/</span> <span class="va">optstrata</span><span class="op">$</span><span class="va">Nh</span><span class="op">)</span> <span class="op">*</span> <span class="va">S2z_h</span> <span class="op">/</span> <span class="va">n_h</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.006210289</code></pre>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#The sampling variance can be computed without error from the population</span>
<span class="va">S2z_h_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">dt</span><span class="op">$</span><span class="va">sim1</span>,
                    INDEX <span class="op">=</span> <span class="va">dt</span><span class="op">$</span><span class="va">strate</span>, 
                    FUN <span class="op">=</span> <span class="va">var</span><span class="op">)</span>

<span class="op">(</span><span class="va">v_mz_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w_h</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">n_h</span> <span class="op">/</span> <span class="va">optstrata</span><span class="op">$</span><span class="va">Nh</span><span class="op">)</span> <span class="op">*</span> <span class="va">S2z_h_pop</span> <span class="op">/</span> <span class="va">n_h</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.02652138</code></pre>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#compute gain in precision due to stratification (stratification effect)</span>
<span class="va">v_mz_SI_true</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">n.echantillons</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">optstrata</span><span class="op">$</span><span class="va">Nh</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">dt</span><span class="op">$</span><span class="va">sim1</span><span class="op">)</span> <span class="op">/</span> <span class="va">n.echantillons</span>
<span class="op">(</span><span class="va">gain</span> <span class="op">&lt;-</span> <span class="va">v_mz_SI_true</span> <span class="op">/</span> <span class="va">v_mz_true</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 1.280028</code></pre>
<p>Voici donc la moyenne STSI <span class="math inline">\(5.1893597\)</span> et la variance dans ce cas <span class="math inline">\(0.0062103\)</span></p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># calcul de l'interval de confiance selon les deux lois</span>
<span class="va">ICT</span> <span class="op">&lt;-</span> <span class="va">talpha</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">v_mz</span><span class="op">)</span>

<span class="co"># comme n&lt; 30, on garde ICT</span>
<span class="co"># Est-ce que la vraie moyenne est dans l'IC student</span>
<span class="va">Moy</span> <span class="op">&lt;</span> <span class="va">mz</span> <span class="op">+</span> <span class="va">ICT</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Moy</span> <span class="op">&gt;</span> <span class="va">mz</span> <span class="op">-</span> <span class="va">ICT</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">mz</span>, 
      ICbas <span class="op">=</span> <span class="va">mz</span> <span class="op">-</span> <span class="va">ICT</span>,
      ICHaut <span class="op">=</span> <span class="va">mz</span> <span class="op">+</span> <span class="va">ICT</span>, <span class="va">Moy</span><span class="op">)</span></code></pre></div>
<pre><code>##           mz    ICbas   ICHaut      Moy
## [1,] 5.18936 5.024418 5.354301 5.298602</code></pre>
<p>Pour mémoire, voici le résultat pour les strates compactes</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resSC</span></code></pre></div>
<pre><code>##      MoyEstSTSI    ICbas   ICHaut      Moy
## [1,]   5.055314 4.892605 5.218023 5.298602</code></pre>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="SI.html"><span class="header-section-number">4</span> Echantillonnage aléatoire simple</a></div>
<div class="next"><a href="SY-QUICK.html"><span class="header-section-number">6</span> Echantillonnage aléatoire systématique</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#l%C3%A9chantillonnage-al%C3%A9atoire-stratifi%C3%A9"><span class="header-section-number">5</span> L’échantillonnage aléatoire stratifié</a></li>
<li><a class="nav-link" href="#pourquoi-stratifier"><span class="header-section-number">5.1</span> Pourquoi stratifier ?</a></li>
<li><a class="nav-link" href="#comment-stratifier"><span class="header-section-number">5.2</span> Comment stratifier ?</a></li>
<li><a class="nav-link" href="#estimateurs-stsi"><span class="header-section-number">5.3</span> Estimateurs STSI</a></li>
<li>
<a class="nav-link" href="#stratification-g%C3%A9ographique-par-strates-compactes-g%C3%A9ographiques"><span class="header-section-number">5.4</span> Stratification géographique par strates compactes géographiques</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#d%C3%A9finition-2"><span class="header-section-number">5.4.1</span> Définition</a></li>
<li><a class="nav-link" href="#estimateurs-stsi-1"><span class="header-section-number">5.4.2</span> Estimateurs STSI</a></li>
<li><a class="nav-link" href="#impl%C3%A9mentation"><span class="header-section-number">5.4.3</span> Implémentation</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#stratification-par-stratification-dune-donn%C3%A9e-quantitative"><span class="header-section-number">5.5</span> Stratification par stratification d’une donnée quantitative</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#d%C3%A9finition-3"><span class="header-section-number">5.5.1</span> Définition</a></li>
<li><a class="nav-link" href="#implementation"><span class="header-section-number">5.5.2</span> Implementation</a></li>
<li><a class="nav-link" href="#estimation"><span class="header-section-number">5.5.3</span> Estimation</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Cours sur les plans d’échantillonnage statistique dans l’espace pour l’étude des sols</strong>" was written by Nicolas Saby, INRAe Infosol, Orléans France. It was last built on 2023-01-11.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
